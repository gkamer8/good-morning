{% extends "pages/docs/layout.html" %}

{% block title %}Development{% endblock %}

{% block doc_content %}
<p>This guide covers setting up a local development environment for Morning Drive.</p>

<h3>Backend Development</h3>

<h4>Quick Start</h4>
<p>Run the backend in development mode with auto-reload:</p>
<pre><code>cd backend

# Copy environment configuration (first time only)
cp .env.example .env
# Edit .env with your API keys

# Start in development mode
./dev.sh</code></pre>

<p>This script:</p>
<ul>
    <li>Automatically detects your machine's IP address</li>
    <li>Starts the server with hot-reload enabled</li>
    <li>Mounts source code so changes apply instantly</li>
    <li>Starts MinIO for music storage</li>
</ul>

<div class="note">
    <strong>Auto-reload:</strong> When running via <code>dev.sh</code>, any changes to Python files in <code>src/</code> will automatically reload the server. No rebuild required!
</div>

<details>
<summary><strong>Alternative: Running Without Docker</strong></summary>
<pre><code>cd backend

# Create a virtual environment
python -m venv venv
source venv/bin/activate

# Install in development mode
pip install -e ".[dev]"

# Copy environment configuration
cp .env.example .env
# Edit .env with your API keys

# Start the development server
python -m src.main</code></pre>
</details>

<h4>Running MinIO for Music Storage</h4>
<pre><code># Start just the MinIO service (if not using dev.sh)
docker compose up -d minio

# MinIO Console: http://localhost:9001
# Default credentials: minioadmin / minioadmin</code></pre>

<h4>Viewing Logs</h4>
<pre><code># Follow backend logs
docker compose logs -f morning-drive

# View last 100 lines
docker compose logs --tail 100 morning-drive</code></pre>

<h3>iOS App Development</h3>

<h4>Prerequisites</h4>
<ul>
    <li>macOS with Xcode installed</li>
    <li>Node.js 18+ and npm</li>
    <li>CocoaPods (<code>brew install cocoapods</code>)</li>
</ul>

<h4>Initial Setup</h4>
<pre><code>cd MorningDriveApp

# Install JavaScript dependencies
npm install

# Install iOS native dependencies
cd ios && pod install && cd ..</code></pre>

<h4>Starting the Metro Bundler</h4>
<p>Metro is the JavaScript bundler for React Native. It must be running for the app to load:</p>
<pre><code># Start Metro (keep this terminal open)
npx react-native start

# Metro runs on http://localhost:8081</code></pre>

<h4>Running on iOS Simulator</h4>
<pre><code># In a new terminal, run the app
npx react-native run-ios

# Or specify a simulator
npx react-native run-ios --simulator="iPhone 15 Pro"</code></pre>

<h4>Running on Physical iPhone</h4>
<ol>
    <li>Connect your iPhone via USB</li>
    <li>Open <code>ios/MorningDriveApp.xcworkspace</code> in Xcode</li>
    <li>Select your device from the device dropdown</li>
    <li>Click the Run button (or press Cmd+R)</li>
</ol>

<div class="note">
    <strong>First-time setup:</strong> You'll need to configure code signing in Xcode with your Apple Developer account.
</div>

<h4>Connecting the App to Metro (Physical Device)</h4>
<p>When running on a physical device, the app needs to connect to Metro on your computer:</p>
<pre><code># Find your computer's IP address
ipconfig getifaddr en0  # macOS</code></pre>
<p>On your iPhone:</p>
<ol>
    <li>Shake the device to open the React Native dev menu</li>
    <li>Tap <strong>"Configure Bundler"</strong></li>
    <li>Enter your computer's IP (e.g., <code>192.168.1.100</code>) and port <code>8081</code></li>
    <li>Tap <strong>"Reload"</strong></li>
</ol>

<h4>Connecting the App to Backend Server</h4>
<p>The app also needs to connect to the Morning Drive backend:</p>
<ol>
    <li>Open the app and go to <strong>Settings</strong></li>
    <li>In the Server URL field, enter your backend URL (e.g., <code>http://192.168.1.100:8000</code>)</li>
    <li>Tap <strong>"Save & Connect"</strong></li>
</ol>

<div class="note">
    <strong>Tip:</strong> The backend admin panel shows the server URL you need. Log in at <code>http://localhost:8000/admin</code> to see it.
</div>

<h4>Troubleshooting</h4>
<table>
    <thead>
        <tr><th>Problem</th><th>Solution</th></tr>
    </thead>
    <tbody>
        <tr><td>App shows white screen</td><td>Make sure Metro is running. Shake device and tap "Reload"</td></tr>
        <tr><td>Settings page stuck loading</td><td>Backend is unreachable. Check server URL in Settings (always visible at top)</td></tr>
        <tr><td>"Unable to load script"</td><td>Metro not reachable. Check IP and port in bundler settings</td></tr>
        <tr><td>Metro shows "BUNDLE" but app doesn't update</td><td>Shake device and tap "Reload", or restart Metro</td></tr>
        <tr><td>Can't connect to backend</td><td>Ensure phone and computer are on same WiFi network</td></tr>
    </tbody>
</table>

<h3>Running Tests</h3>

<h4>Backend Tests</h4>
<pre><code>cd backend
pytest

# Run with coverage
pytest --cov=src</code></pre>

<h4>iOS Tests</h4>
<pre><code>cd MorningDriveApp
npm test</code></pre>

<h3>Code Quality</h3>

<h4>Backend Linting</h4>
<pre><code># Run ruff linter
ruff check src/

# Auto-fix issues
ruff check src/ --fix

# Format code
ruff format src/</code></pre>

<h4>iOS Linting</h4>
<pre><code># Run ESLint
npm run lint

# Fix auto-fixable issues
npm run lint -- --fix</code></pre>

<h3>Project Structure</h3>
<pre><code>good-morning/
├── backend/
│   ├── src/
│   │   ├── api/          # REST API routes
│   │   ├── agents/       # Claude content generation
│   │   ├── tools/        # Data fetching (news, sports, weather)
│   │   ├── audio/        # TTS and audio mixing
│   │   ├── storage/      # Database and file storage
│   │   └── templates/    # Website HTML templates
│   ├── assets/           # Audio assets (intro, outro, transitions)
│   ├── data/             # SQLite database, generated audio
│   └── tests/            # Test suite
└── MorningDriveApp/      # React Native iOS app
    ├── src/
    │   ├── screens/      # App screens
    │   ├── components/   # Reusable components
    │   ├── services/     # API client, audio player
    │   └── store/        # State management (Zustand)
    ├── ios/              # Native iOS project
    └── docs/             # iOS distribution guides</code></pre>

<h3>Custom Audio Assets</h3>
<p>Replace placeholder audio in <code>backend/assets/</code>:</p>
<ul>
    <li><code>intro.mp3</code> - Intro music/jingle</li>
    <li><code>transition.mp3</code> - Transition sound between segments</li>
    <li><code>outro.mp3</code> - Outro music</li>
</ul>

<h3>Useful Commands</h3>
<pre><code># View backend logs
docker-compose logs -f morning-drive

# Restart a specific service
docker-compose restart morning-drive

# Access MinIO console
open http://localhost:9001

# Check API documentation
open http://localhost:8000/api/docs</code></pre>
{% endblock %}
