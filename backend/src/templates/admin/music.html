{% extends "base.html" %}

{% block title %}Music Management{% endblock %}

{% block content %}
<div class="container-wide">
    {% if success %}
    <div class="message success">{{ success }}</div>
    {% endif %}
    {% if error %}
    <div class="message error">{{ error }}</div>
    {% endif %}

    {% if server_url %}
    <div class="card card-gradient">
        <div class="card-body" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
                <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 4px;">App Server URL</div>
                <div style="font-size: 1.4rem; font-weight: 600; font-family: monospace;">{{ server_url }}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 0.85rem; opacity: 0.9;">Enter this URL in the Morning Drive app settings to connect</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">Music Library</div>
        <table>
            <thead>
                <tr>
                    <th>Title / Composer</th>
                    <th>Duration</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if pieces %}
                {% for piece in pieces %}
                <tr>
                    <td><strong>{{ piece.title }}</strong><br><span class="composer">{{ piece.composer }}</span></td>
                    <td>{{ "%.1f"|format(piece.duration_seconds / 60) }} min</td>
                    <td>{{ "%.1f"|format(piece.file_size_bytes / 1024 / 1024) }} MB</td>
                    <td>
                        {% if piece.is_active %}
                        <span class="badge active">Active</span>
                        {% else %}
                        <span class="badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn-play" onclick="togglePlay({{ piece.id }}, this)" data-piece-id="{{ piece.id }}">&#9654; Play</button>
                        <form method="POST" action="/admin/music/{{ piece.id }}/delete" style="display:inline;">
                            <button type="submit" class="btn-delete" onclick="return confirm('Delete {{ piece.title }}?')">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="5" class="empty">No music pieces yet. Upload one below!</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">Upload New Music</div>
        <div class="card-body">
            <form method="POST" action="/admin/music/upload" enctype="multipart/form-data">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required placeholder="e.g., Moonlight Sonata">
                    </div>
                    <div class="form-group">
                        <label for="composer">Composer *</label>
                        <input type="text" id="composer" name="composer" required placeholder="e.g., Ludwig van Beethoven">
                    </div>
                </div>
                <div class="form-group">
                    <label for="file">Audio File (MP3) *</label>
                    <input type="file" id="file" name="file" accept="audio/mpeg,audio/mp3" required>
                    <p class="help" style="margin-top: 8px; color: #666;">
                        Duration will be auto-detected from the audio file.<br>
                        An introduction will be auto-generated by AI based on the title and composer.
                    </p>
                </div>
                <button type="submit" class="btn-primary">Upload Music</button>
            </form>
        </div>
    </div>
</div>

<!-- Audio Player (fixed position at bottom) -->
<div id="audio-player">
    <div class="now-playing">
        <div class="title" id="player-title">-</div>
        <div class="composer" id="player-composer">-</div>
    </div>
    <audio id="audio-element" controls></audio>
    <button class="close-btn" onclick="closePlayer()">&times;</button>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentPieceId = null;
    const audioElement = document.getElementById('audio-element');
    const playerDiv = document.getElementById('audio-player');
    const playerTitle = document.getElementById('player-title');
    const playerComposer = document.getElementById('player-composer');

    function togglePlay(pieceId, button) {
        const title = button.closest('tr').querySelector('td:first-child strong').textContent;
        const composer = button.closest('tr').querySelector('td:first-child .composer').textContent;

        if (currentPieceId === pieceId && !audioElement.paused) {
            // Pause current
            audioElement.pause();
            button.textContent = '\u25B6 Play';
        } else {
            // Reset all play buttons
            document.querySelectorAll('.btn-play').forEach(btn => btn.textContent = '\u25B6 Play');

            // Play new or resume
            if (currentPieceId !== pieceId) {
                audioElement.src = `/api/music/${pieceId}/stream`;
                currentPieceId = pieceId;
                playerTitle.textContent = title;
                playerComposer.textContent = composer;
            }
            audioElement.play();
            button.textContent = '\u23F8 Pause';
            playerDiv.classList.add('visible');
        }
    }

    function closePlayer() {
        audioElement.pause();
        audioElement.src = '';
        currentPieceId = null;
        playerDiv.classList.remove('visible');
        document.querySelectorAll('.btn-play').forEach(btn => btn.textContent = '\u25B6 Play');
    }

    audioElement.addEventListener('ended', () => {
        document.querySelectorAll('.btn-play').forEach(btn => btn.textContent = '\u25B6 Play');
    });

    audioElement.addEventListener('pause', () => {
        if (currentPieceId) {
            const btn = document.querySelector(`button[data-piece-id="${currentPieceId}"]`);
            if (btn) btn.textContent = '\u25B6 Play';
        }
    });

    audioElement.addEventListener('play', () => {
        if (currentPieceId) {
            const btn = document.querySelector(`button[data-piece-id="${currentPieceId}"]`);
            if (btn) btn.textContent = '\u23F8 Pause';
        }
    });
</script>
{% endblock %}
