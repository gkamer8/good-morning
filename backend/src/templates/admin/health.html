{% extends "base.html" %}

{% block title %}Health Check{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="status-banner {{ overall_status }}">
        <div>
            <h2>{{ overall_text }}</h2>
            <div class="stats">
                <span>{{ ok_count }}/{{ total_count }} services healthy</span>
            </div>
        </div>
        <a href="/admin/health" class="refresh-btn">Refresh</a>
    </div>

    <div class="card">
        <div class="card-header">
            RSS News Feeds
            <span class="count">{{ rss_results|length }} sources</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Response Time</th>
                    <th>Error</th>
                    <th>Preview</th>
                </tr>
            </thead>
            <tbody>
                {% for result in rss_results %}
                <tr>
                    <td><strong>{{ result.name }}</strong></td>
                    <td>
                        {% if result.status == 'ok' %}
                        <span class="badge ok">OK</span>
                        {% elif result.status == 'configured' %}
                        <span class="badge configured">Configured</span>
                        {% elif result.status == 'not_configured' %}
                        <span class="badge warning">Not Configured</span>
                        {% elif result.status == 'timeout' %}
                        <span class="badge warning">Timeout</span>
                        {% else %}
                        <span class="badge error">Error</span>
                        {% endif %}
                    </td>
                    <td class="{% if result.response_time_ms < 500 %}fast{% elif result.response_time_ms > 2000 %}slow{% endif %}">{{ result.response_time_ms }}ms</td>
                    <td class="error-text">{{ result.error or '-' }}</td>
                    <td>
                        {% if result.status == 'ok' %}
                        <button class="preview-btn" onclick="showRssPreview('{{ result.name }}')">Preview</button>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">
            External APIs
            <span class="count">{{ api_results|length }} services</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Response Time</th>
                    <th>Error</th>
                    <th>Preview</th>
                </tr>
            </thead>
            <tbody>
                {% for result in api_results %}
                <tr>
                    <td><strong>{{ result.name }}</strong></td>
                    <td>
                        {% if result.status == 'ok' %}
                        <span class="badge ok">OK</span>
                        {% elif result.status == 'configured' %}
                        <span class="badge configured">Configured</span>
                        {% elif result.status == 'not_configured' %}
                        <span class="badge warning">Not Configured</span>
                        {% elif result.status == 'timeout' %}
                        <span class="badge warning">Timeout</span>
                        {% else %}
                        <span class="badge error">Error</span>
                        {% endif %}
                    </td>
                    <td class="{% if result.response_time_ms < 500 %}fast{% elif result.response_time_ms > 2000 %}slow{% endif %}">{{ result.response_time_ms }}ms</td>
                    <td class="error-text">{{ result.error or '-' }}</td>
                    <td>
                        {% if result.status == 'ok' %}
                        {% if 'ESPN' in result.name %}
                        <button class="preview-btn" onclick="showSportsPreview()">My Sports</button>
                        {% else %}
                        <button class="preview-btn" onclick="showApiPreview('{{ result.name }}')">Preview</button>
                        {% endif %}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">
            Internal Services
            <span class="count">{{ internal_results|length }} services</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Response Time</th>
                    <th>Error</th>
                </tr>
            </thead>
            <tbody>
                {% for result in internal_results %}
                <tr>
                    <td><strong>{{ result.name }}</strong></td>
                    <td>
                        {% if result.status == 'ok' %}
                        <span class="badge ok">OK</span>
                        {% elif result.status == 'configured' %}
                        <span class="badge configured">Configured</span>
                        {% elif result.status == 'not_configured' %}
                        <span class="badge warning">Not Configured</span>
                        {% elif result.status == 'timeout' %}
                        <span class="badge warning">Timeout</span>
                        {% else %}
                        <span class="badge error">Error</span>
                        {% endif %}
                    </td>
                    <td class="{% if result.response_time_ms < 500 %}fast{% elif result.response_time_ms > 2000 %}slow{% endif %}">{{ result.response_time_ms }}ms</td>
                    <td class="error-text">{{ result.error or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <p class="timestamp" style="text-align: center; color: #666; font-size: 0.85rem; margin-top: 20px;">
        Last checked: {{ last_checked }}
    </p>
</div>

<!-- RSS Preview Modal -->
<div id="rss-modal" class="modal" onclick="if(event.target===this) closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">RSS Feed Preview</h3>
            <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <div class="loading">Loading stories...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function showRssPreview(feedName) {
        const modal = document.getElementById('rss-modal');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');

        title.textContent = feedName + ' - Recent Stories';
        body.innerHTML = '<div class="loading">Loading stories...</div>';
        modal.classList.add('show');

        fetch('/admin/rss-preview?feed=' + encodeURIComponent(feedName))
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    body.innerHTML = '<div class="error-msg">' + data.error + '</div>';
                    return;
                }

                if (data.stories.length === 0) {
                    body.innerHTML = '<div class="no-stories">No stories found</div>';
                    return;
                }

                let html = '<ul class="story-list">';
                data.stories.forEach(story => {
                    const date = story.published ? '<span class="story-date">' + story.published + '</span>' : '';
                    html += `
                        <li class="story-item">
                            <a href="${story.link}" target="_blank" rel="noopener">${story.title}</a>
                            ${date}
                            ${story.summary ? '<p class="story-summary">' + story.summary + '</p>' : ''}
                        </li>
                    `;
                });
                html += '</ul>';
                body.innerHTML = html;
            })
            .catch(err => {
                body.innerHTML = '<div class="error-msg">Failed to load: ' + err.message + '</div>';
            });
    }

    function showApiPreview(apiName) {
        const modal = document.getElementById('rss-modal');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');

        title.textContent = apiName + ' - Preview';
        body.innerHTML = '<div class="loading">Loading data...</div>';
        modal.classList.add('show');

        fetch('/admin/api-preview?api=' + encodeURIComponent(apiName))
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    body.innerHTML = '<div class="error-msg">' + data.error + '</div>';
                    return;
                }

                if (!data.items || data.items.length === 0) {
                    body.innerHTML = '<div class="no-stories">No data found</div>';
                    return;
                }

                let html = '';

                if (data.type === 'events') {
                    // This Day in History
                    html = '<ul class="story-list">';
                    data.items.forEach(item => {
                        html += `
                            <li class="story-item">
                                <strong>${item.year}</strong>: ${item.text}
                            </li>
                        `;
                    });
                    html += '</ul>';
                } else if (data.type === 'quote') {
                    // Quote of the Day
                    const item = data.items[0];
                    html = `
                        <blockquote class="quote-preview">
                            <p>"${item.quote}"</p>
                            <footer>â€” ${item.author}</footer>
                        </blockquote>
                    `;
                } else if (data.type === 'joke') {
                    // Dad Joke
                    const item = data.items[0];
                    html = `
                        <div class="joke-preview">
                            <p>${item.joke}</p>
                        </div>
                    `;
                } else if (data.type === 'weather') {
                    // Weather
                    const item = data.items[0];
                    html = `
                        <div class="weather-preview">
                            <div class="weather-stat"><strong>Temperature:</strong> ${item.temperature}</div>
                            <div class="weather-stat"><strong>Wind Speed:</strong> ${item.windspeed}</div>
                            <div class="weather-stat"><strong>Weather Code:</strong> ${item.weathercode}</div>
                            <div class="weather-stat"><strong>Time:</strong> ${item.time}</div>
                        </div>
                    `;
                } else if (data.type === 'sports') {
                    // Sports
                    html = '<ul class="story-list">';
                    data.items.forEach(item => {
                        html += `
                            <li class="story-item">
                                <strong>${item.name}</strong>
                                ${item.score ? '<div class="score">' + item.score + '</div>' : ''}
                                ${item.status ? '<span class="story-date">' + item.status + '</span>' : ''}
                            </li>
                        `;
                    });
                    html += '</ul>';
                } else if (data.type === 'market') {
                    // Market Data (Yahoo Finance)
                    html = '<ul class="story-list">';
                    data.items.forEach(item => {
                        html += `
                            <li class="story-item">
                                <strong>${item.symbol}</strong> (${item.name})<br>
                                <div class="score">${item.price} ${item.change}</div>
                                <span class="story-date">Day Range: ${item.low} - ${item.high}</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                } else {
                    // Generic JSON/text
                    html = '<pre class="json-preview">' + (data.items[0].raw || JSON.stringify(data.items, null, 2)) + '</pre>';
                }

                body.innerHTML = html;
            })
            .catch(err => {
                body.innerHTML = '<div class="error-msg">Failed to load: ' + err.message + '</div>';
            });
    }

    function showSportsPreview() {
        const modal = document.getElementById('rss-modal');
        const title = document.getElementById('modal-title');
        const body = document.getElementById('modal-body');

        title.textContent = 'Sports Preview (Your Settings)';
        body.innerHTML = '<div class="loading">Fetching sports data from your configured leagues...</div>';
        modal.classList.add('show');

        fetch('/admin/sports-preview')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    body.innerHTML = '<div class="error-msg">' + data.error + '</div>';
                    return;
                }

                if (data.message) {
                    body.innerHTML = '<div class="no-stories">' + data.message + '</div>';
                    return;
                }

                let html = '';

                // Show configured settings
                html += '<div class="sports-config">';
                html += '<p><strong>Configured Leagues:</strong> ' + (data.configured_leagues.join(', ') || 'None') + '</p>';
                if (data.configured_teams && data.configured_teams.length > 0) {
                    const teamNames = data.configured_teams.map(t => t.name + ' (' + t.league + ')').join(', ');
                    html += '<p><strong>Tracked Teams:</strong> ' + teamNames + '</p>';
                }
                html += '</div><hr style="margin: 16px 0; border: none; border-top: 1px solid #eee;">';

                // Show team games first if any
                if (data.team_games && data.team_games.length > 0) {
                    html += '<h4 style="margin: 16px 0 12px 0; color: #667eea;">Your Teams</h4>';
                    html += '<ul class="story-list">';
                    data.team_games.forEach(game => {
                        let scoreText = '';
                        if (game.status === 'final' || game.status === 'in_progress') {
                            scoreText = game.away_score + ' - ' + game.home_score;
                        }
                        html += `
                            <li class="story-item">
                                <strong>${game.away_team} @ ${game.home_team}</strong>
                                ${scoreText ? '<div class="score">' + scoreText + '</div>' : ''}
                                <span class="story-date">${game.league} - ${game.status}</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }

                // Show league scoreboards
                if (data.leagues && data.leagues.length > 0) {
                    data.leagues.forEach(league => {
                        html += '<h4 style="margin: 16px 0 12px 0; color: #667eea;">' + league.league + '</h4>';

                        if (league.error) {
                            html += '<div class="error-msg">' + league.error + '</div>';
                            return;
                        }

                        if (league.games.length === 0) {
                            html += '<p style="color: #666; font-style: italic;">No games today</p>';
                            return;
                        }

                        html += '<p style="font-size: 0.8rem; color: #888; margin-bottom: 8px;">Endpoint: ' + league.endpoint + '</p>';
                        html += '<ul class="story-list">';
                        league.games.forEach(game => {
                            let scoreText = '';
                            if (game.status === 'final' || game.status === 'in_progress') {
                                scoreText = (game.away_score || 0) + ' - ' + (game.home_score || 0);
                            }
                            const statusBadge = game.status === 'final' ? 'Final' :
                                               game.status === 'in_progress' ? 'LIVE' :
                                               game.start_time ? new Date(game.start_time).toLocaleTimeString() : 'Scheduled';
                            html += `
                                <li class="story-item">
                                    <strong>${game.away_team} @ ${game.home_team}</strong>
                                    ${scoreText ? '<div class="score">' + scoreText + '</div>' : ''}
                                    <span class="story-date">${statusBadge}</span>
                                </li>
                            `;
                        });
                        html += '</ul>';
                        if (league.total_games > 5) {
                            html += '<p style="font-size: 0.85rem; color: #666;">+ ' + (league.total_games - 5) + ' more games</p>';
                        }
                    });
                }

                body.innerHTML = html;
            })
            .catch(err => {
                body.innerHTML = '<div class="error-msg">Failed to load: ' + err.message + '</div>';
            });
    }

    function closeModal() {
        document.getElementById('rss-modal').classList.remove('show');
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });
</script>
{% endblock %}
